name: Cron

on:
  schedule:
    - cron: "1 6 * * *"
  workflow_dispatch:

env:
  CI: true
  PYTHON_VERSION: 3.12
  PIPENV_VENV_IN_PROJECT: true
  SCRAPY_SETTINGS_MODULE: city_scrapers.settings.prod
  WAYBACK_ENABLED: true
  AUTOTHROTTLE_MAX_DELAY: 30.0
  AUTOTHROTTLE_START_DELAY: 1.5
  AUTOTHROTTLE_TARGET_CONCURRENCY: 3.0
  AZURE_ACCOUNT_KEY: ${{ secrets.AZURE_ACCOUNT_KEY }}
  AZURE_ACCOUNT_NAME: ${{ secrets.AZURE_ACCOUNT_NAME }}
  AZURE_CONTAINER: ${{ secrets.AZURE_CONTAINER }}
  AZURE_STATUS_CONTAINER: ${{ secrets.AZURE_STATUS_CONTAINER }}
  SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

jobs:
  # crawl:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: Set up Python ${{ env.PYTHON_VERSION }}
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ env.PYTHON_VERSION }}

  #     - name: Install Pipenv
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install pipenv

  #     - name: Cache Python dependencies
  #       uses: actions/cache@v4
  #       with:
  #         path: .venv
  #         key: ${{ env.PYTHON_VERSION }}-${{ hashFiles('**/Pipfile.lock') }}
  #         restore-keys: |
  #           ${{ env.PYTHON_VERSION }}-
  #           pip-

  #     - name: Check and conditionally remove invalid virtual environment
  #       run: |
  #         if [ -d ".venv" ] && [ ! -f ".venv/bin/python" ]; then
  #           echo "Virtual environment exists but Python executable is missing. Rebuilding."
  #           rm -rf .venv
  #         elif [ ! -d ".venv" ]; then
  #           echo "No virtual environment found. Will build new one."
  #         else
  #           echo "Virtual environment appears valid. Reusing."
  #         fi

  #     - name: Install dependencies
  #       run: pipenv sync
  #       env:
  #         PIPENV_DEFAULT_PYTHON_VERSION: ${{ env.PYTHON_VERSION }}

      # - name: Run scrapers
      #   run: |
      #     export PYTHONPATH=$(pwd):$PYTHONPATH
      #     ./.deploy.sh

      # - name: Combine output feeds
      #   run: |
      #     export PYTHONPATH=$(pwd):$PYTHONPATH
      #     pipenv run scrapy combinefeeds -s LOG_ENABLED=False

  crawl_v2:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Pipenv
        run: |
          python -m pip install --upgrade pip
          pip install pipenv

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: v2-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/Pipfile.lock') }}
          restore-keys: |
            v2-${{ env.PYTHON_VERSION }}-
            v2-pip-

      - name: Check and conditionally remove invalid virtual environment
        run: |
          if [ -d ".venv" ] && [ ! -f ".venv/bin/python" ]; then
            echo "Virtual environment exists but Python executable is missing. Rebuilding."
            rm -rf .venv
          elif [ ! -d ".venv" ]; then
            echo "No virtual environment found. Will build new one."
          else
            echo "Virtual environment appears valid. Reusing."
          fi

      - name: Install dependencies
        run: pipenv sync
        env:
          PIPENV_DEFAULT_PYTHON_VERSION: ${{ env.PYTHON_VERSION }}

      - name: Install Playwright browsers
        run: pipenv run playwright install chromium

      - name: Run v2 scrapers
        run: |
          export PYTHONPATH=$(pwd):$PYTHONPATH
          ./.deploy-harambe.sh

      - name: Verify v2 scraper output in Azure
        run: |
          # Install Azure CLI storage extension if needed
          pip install azure-storage-blob

          # List blobs created today for verification
          python -c "
          from azure.storage.blob import BlobServiceClient
          from datetime import datetime
          import os

          account_name = os.getenv('AZURE_ACCOUNT_NAME')
          account_key = os.getenv('AZURE_ACCOUNT_KEY')
          container = os.getenv('AZURE_CONTAINER')

          conn_str = f'DefaultEndpointsProtocol=https;AccountName={account_name};AccountKey={account_key};EndpointSuffix=core.windows.net'
          blob_service = BlobServiceClient.from_connection_string(conn_str)
          container_client = blob_service.get_container_client(container)

          now = datetime.now()
          prefix = f'{now.year}/{now.month:02d}/{now.day:02d}/'

          print(f'Checking for blobs with prefix: {prefix}')
          print(f'Container: {container}')
          print(f'Storage Account: {account_name}')
          print('=' * 80)

          blobs = list(container_client.list_blobs(name_starts_with=prefix))

          v2_blobs = [b for b in blobs if 'det_police_fire_retirement_v2' in b.name]

          if v2_blobs:
              print(f'✓ Found {len(v2_blobs)} det_police_fire_retirement_v2 blob(s):\n')
              for blob in v2_blobs:
                  blob_client = container_client.get_blob_client(blob.name)
                  blob_url = blob_client.url

                  # Generate a SAS URL for easy download (valid for 1 hour)
                  from azure.storage.blob import generate_blob_sas, BlobSasPermissions
                  from datetime import timedelta

                  sas_token = generate_blob_sas(
                      account_name=account_name,
                      container_name=container,
                      blob_name=blob.name,
                      account_key=account_key,
                      permission=BlobSasPermissions(read=True),
                      expiry=datetime.utcnow() + timedelta(hours=1)
                  )

                  download_url = f'{blob_url}?{sas_token}'

                  print(f'  Blob: {blob.name}')
                  print(f'  Size: {blob.size:,} bytes')
                  print(f'  Last Modified: {blob.last_modified}')
                  print(f'  Direct URL: {blob_url}')
                  print(f'  Download URL (valid 1hr): {download_url}')
                  print('-' * 40)
          else:
              print('⚠ No det_police_fire_retirement_v2 blobs found')
              print(f'\\nAll blobs found with prefix {prefix}:')
              for blob in blobs[:10]:  # Show first 10 for debugging
                  print(f'  - {blob.name} ({blob.size:,} bytes)')
              if len(blobs) > 10:
                  print(f'  ... and {len(blobs) - 10} more')
          "
